<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE Diary Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* LINE風の背景色とフォント設定 */
        body { 
            background-color: #7494c0; 
            color: #1e293b; 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; overflow: hidden; /* 全体スクロール禁止 */
        }
        /* スクロールバー非表示 */
        ::-webkit-scrollbar { display: none; }
        
        /* 吹き出しのしっぽ（右・左） */
        .bubble-tail-r::after { content: ""; position: absolute; top: 12px; right: -8px; border-style: solid; border-width: 6px 0 6px 8px; border-color: transparent transparent transparent #8de055; }
        .bubble-tail-l::after { content: ""; position: absolute; top: 12px; left: -8px; border-style: solid; border-width: 6px 8px 6px 0; border-color: transparent #ffffff transparent transparent; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_VERSION = "v1beta";

        // カレンダー計算用
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const App = () => {
            // ★修正1：画面描画前にlocalStorageを確認（これで毎回聞かれない）
            const [apiKey, setApiKey] = useState(() => localStorage.getItem("gemini_api_key_new") || "");
            const [hasKey, setHasKey] = useState(() => !!localStorage.getItem("gemini_api_key_new"));
            
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState(() => localStorage.getItem("gemini_selected_model") || "");
            
            const [activeTab, setActiveTab] = useState("chat");
            const [messages, setMessages] = useState([]);
            const [diaries, setDiaries] = useState({});
            const [inputText, setInputText] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [selectedImage, setSelectedImage] = useState(null);
            const [selectedImageBase64, setSelectedImageBase64] = useState(null);
            
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDateDetail, setSelectedDateDetail] = useState(null);

            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // 初期化処理
            useEffect(() => {
                // キーがあるなら即座にモデルリストを取得
                if (hasKey && apiKey) {
                    fetchModels(apiKey);
                }
                
                const savedMsgs = localStorage.getItem("ai_diary_messages");
                const savedDiaries = localStorage.getItem("ai_diary_entries_map");
                if (savedMsgs) setMessages(JSON.parse(savedMsgs));
                if (savedDiaries) setDiaries(JSON.parse(savedDiaries));
            }, []); // 初回のみ実行

            // データ保存の監視
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); if (activeTab === 'chat') scrollToBottom(); }, [messages, activeTab]);
            useEffect(() => { localStorage.setItem("ai_diary_messages", JSON.stringify(messages)); }, [messages]);
            useEffect(() => { localStorage.setItem("ai_diary_entries_map", JSON.stringify(diaries)); }, [diaries]);

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };

            const fetchModels = async (key) => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/${API_VERSION}/models?key=${key}`);
                    const data = await res.json();
                    if (!res.ok) return;
                    
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""))
                        .sort();
                    
                    setAvailableModels(models);

                    // まだモデルを選んでいない場合、賢いモデルを自動選択
                    if (!selectedModel && models.length > 0) {
                        const best = models.find(m => m.includes("27b")) || models.find(m => m.includes("12b")) || models[0];
                        setSelectedModel(best);
                        localStorage.setItem("gemini_selected_model", best);
                    }
                } catch (e) { console.error(e); }
            };

            const sendToGemini = async (prompt, imageBase64) => {
                const target = selectedModel || "gemma-3-12b-it"; 
                const url = `https://generativelanguage.googleapis.com/${API_VERSION}/models/${target}:generateContent?key=${apiKey}`;
                
                let parts = [{ text: prompt }];
                if (imageBase64) parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });
                
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || res.statusText);
                return data.candidates[0].content.parts[0].text;
            };

            const handleSend = async () => {
                if ((!inputText.trim() && !selectedImage) || isLoading) return;
                const now = new Date();
                const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const newUserMsg = { id: Date.now(), text: inputText, image: selectedImage, sender: "user", time: timeStr, timestamp: now.toISOString() };
                setMessages(prev => [...prev, newUserMsg]);
                setInputText("");
                setSelectedImage(null);
                setIsLoading(true);

                try {
                    const history = messages.slice(-10).map(m => `${m.sender}: ${m.text}`).join("\n");
                    const prompt = `あなたは親しい友人です。会話の流れを読み、短く、共感的に返信してください。\n\n[履歴]\n${history}\nuser: ${inputText}`;
                    
                    const responseText = await sendToGemini(prompt, selectedImageBase64);
                    
                    const aiNow = new Date();
                    const aiTime = `${aiNow.getHours()}:${String(aiNow.getMinutes()).padStart(2, '0')}`;
                    setMessages(prev => [...prev, { id: Date.now() + 1, text: responseText, sender: "ai", time: aiTime, timestamp: aiNow.toISOString() }]);
                    setSelectedImageBase64(null);
                } catch (e) {
                    setMessages(prev => [...prev, { id: Date.now(), text: `⚠️ エラー: ${e.message}`, sender: "system", time: "--:--" }]);
                } finally { setIsLoading(false); }
            };

            const generateSummary = async () => {
                if (!confirm("本日の会話から日記を作成しますか？")) return;
                setIsLoading(true);
                try {
                    const todayStr = new Date().toDateString();
                    const targetMsgs = messages
                        .filter(m => new Date(m.timestamp).toDateString() === todayStr && m.sender !== 'system')
                        .map(m => `${m.sender}: ${m.text}`)
                        .join("\n");

                    if (!targetMsgs) throw new Error("本日の会話ログがありません。");

                    const prompt = `
あなたはプロの編集者です。以下の会話ログから「今日の日記」を作成してください。
【厳守ルール】
1. 出力は **JSON形式のみ**。マークダウン記号や挨拶は禁止。
2. JSON: {"title": "タイトル", "summary": "300文字程度の日記本文", "weather": "sunny/cloudy/rainy", "tags": ["タグ1"]}

【会話ログ】
${targetMsgs}
`;
                    const raw = await sendToGemini(prompt, null);
                    const jsonStr = raw.replace(/```json|```/g, "").trim();
                    const data = JSON.parse(jsonStr);

                    const todayKey = new Date().toISOString().split('T')[0];
                    setDiaries(prev => ({ ...prev, [todayKey]: { ...data, timestamp: new Date().toISOString() } }));
                    alert(`日記「${data.title}」を保存しました！`);
                    setActiveTab("calendar");

                } catch (e) {
                    alert("作成失敗: " + e.message + "\nモデルを変更して再試行してください。");
                } finally { setIsLoading(false); }
            };

            // ログイン画面
            if (!hasKey) return (
                <div className="h-[100dvh] w-full bg-slate-900 flex flex-col items-center justify-center p-6 text-white">
                    <h1 className="text-2xl font-bold mb-8 text-teal-400">LINE Diary Setup</h1>
                    <p className="text-slate-400 text-sm mb-4">Gemini APIキーを入力してください</p>
                    <input 
                        type="text" 
                        value={apiKey} 
                        onChange={e=>setApiKey(e.target.value)} 
                        placeholder="AIzaSy..." 
                        className="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 mb-6 text-white outline-none focus:border-teal-500"
                    />
                    <button 
                        onClick={()=> {
                            if(apiKey.length < 10) return alert("キーが短すぎます");
                            localStorage.setItem("gemini_api_key_new", apiKey);
                            setHasKey(true);
                            fetchModels(apiKey);
                        }} 
                        className="w-full bg-teal-600 py-4 rounded-xl font-bold text-white active:scale-95 transition-transform"
                    >
                        はじめる
                    </button>
                </div>
            );

            // ★修正2：高さ指定を 100dvh (ダイナミックビューポート) に変更してスマホ対応強化
            return (
                <div className="h-[100dvh] w-full flex flex-col bg-[#7494c0] overflow-hidden">
                    {/* Header */}
                    <header className="h-12 bg-[#f5f5f5]/90 backdrop-blur border-b border-slate-200 flex justify-between items-center px-4 z-20 shadow-sm flex-shrink-0">
                        <div className="flex flex-col">
                            <h1 className="font-bold text-slate-700 text-sm">{activeTab === 'chat' ? (selectedModel || '読込中...') : 'カレンダー'}</h1>
                        </div>
                        <div className="flex gap-4 items-center">
                            {activeTab === 'chat' && (
                                <button onClick={generateSummary} className="bg-emerald-100 p-1.5 rounded-full text-emerald-600 active:bg-emerald-200" title="日記を作成">
                                    <i data-lucide="book-open-check" className="w-5 h-5"></i>
                                </button>
                            )}
                            <div className="relative">
                                <i data-lucide="settings" className="w-5 h-5 text-slate-400"></i>
                                <select 
                                    onChange={e => {setSelectedModel(e.target.value); localStorage.setItem("gemini_selected_model", e.target.value);}} 
                                    value={selectedModel} 
                                    className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
                                >
                                    {availableModels.length > 0 ? availableModels.map(m => <option key={m} value={m}>{m}</option>) : <option>モデル読込中...</option>}
                                </select>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden relative w-full">
                        {activeTab === 'chat' ? (
                            <div className="h-full flex flex-col">
                                {/* Messages Area */}
                                <div className="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
                                    {messages.map((msg) => (
                                        <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} items-end gap-1.5`}>
                                            {msg.sender === 'ai' && (
                                                <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-[10px] font-bold border border-slate-200 text-slate-500 shadow-sm flex-shrink-0">
                                                    AI
                                                </div>
                                            )}
                                            
                                            <div className="flex flex-col max-w-[75%]">
                                                {msg.sender === 'ai' && <span className="text-[10px] text-slate-600 ml-1 mb-0.5">Gemini</span>}
                                                <div className={`relative p-2.5 text-sm rounded-xl shadow-sm leading-relaxed whitespace-pre-wrap ${
                                                    msg.sender === 'user' 
                                                    ? 'bg-[#8de055] text-black bubble-tail-r mr-2 rounded-tr-none' 
                                                    : 'bg-white text-black bubble-tail-l ml-2 rounded-tl-none'
                                                }`}>
                                                    {msg.image && <img src={msg.image} className="rounded mb-2 max-w-full" />}
                                                    {msg.text}
                                                </div>
                                            </div>
                                            
                                            <span className="text-[9px] text-slate-700/80 mb-1 flex-shrink-0 tabular-nums">{msg.time}</span>
                                        </div>
                                    ))}
                                    {isLoading && <div className="text-center text-xs text-white/80 mt-2 animate-pulse">入力中...</div>}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input Area (Bottom Fixed) */}
                                <div className="bg-[#f5f5f5] px-2 py-2 flex items-end gap-2 border-t border-slate-300 pb-safe">
                                    <button onClick={()=>fileInputRef.current.click()} className="text-slate-500 p-2"><i data-lucide="plus" className="w-6 h-6"></i></button>
                                    <input type="file" ref={fileInputRef} onChange={e => {
                                        const file = e.target.files[0];
                                        if(file){
                                            setSelectedImage(URL.createObjectURL(file));
                                            const r = new FileReader();
                                            r.onload = () => setSelectedImageBase64(r.result.replace("data:", "").replace(/^.+,/, ""));
                                            r.readAsDataURL(file);
                                        }
                                    }} className="hidden" />
                                    
                                    <div className="flex-1 bg-white rounded-2xl flex items-center px-3 py-2 border border-slate-300 min-h-[40px]">
                                        <textarea 
                                            value={inputText} 
                                            onChange={e => setInputText(e.target.value)} 
                                            placeholder="メッセージを入力"
                                            className="w-full bg-transparent border-none outline-none text-sm resize-none max-h-24"
                                            rows={inputText.split('\n').length > 1 ? Math.min(inputText.split('\n').length, 4) : 1}
                                        />
                                    </div>
                                    <button onClick={handleSend} disabled={isLoading} className={`p-2 mb-0.5 rounded-full transition-colors ${inputText || selectedImage ? 'text-[#3b82f6]' : 'text-slate-400'}`}>
                                        <i data-lucide="send" className="w-6 h-6"></i>
                                    </button>
                                </div>
                            </div>
                        ) : (
                            // カレンダー表示
                            <div className="h-full flex flex-col bg-white overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b flex justify-between items-center flex-shrink-0">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2"><i data-lucide="chevron-left"></i></button>
                                    <h2 className="font-bold text-lg text-slate-700">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2"><i data-lucide="chevron-right"></i></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-2">
                                    <div className="grid grid-cols-7 gap-1 mb-2 text-center text-xs text-gray-400 font-bold">
                                        <div className="text-red-400">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div className="text-blue-400">土</div>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 auto-rows-fr">
                                        {[...Array(getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()))].map((_, i) => <div key={`empty-${i}`} />)}
                                        {[...Array(getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth()))].map((_, i) => {
                                            const day = i + 1;
                                            const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                            const entry = diaries[dateKey];
                                            return (
                                                <div key={day} 
                                                    onClick={() => entry && setSelectedDateDetail({ date: dateKey, ...entry })}
                                                    className={`aspect-square flex flex-col items-center justify-start pt-1 rounded-md relative cursor-pointer border ${entry ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-transparent'}`}
                                                >
                                                    <span className={`text-sm ${entry ? 'font-bold text-emerald-700' : 'text-slate-700'}`}>{day}</span>
                                                    {entry && <div className="mt-1 w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>}
                                                    {entry && <span className="text-[8px] text-emerald-600 truncate w-full px-1 text-center hidden sm:block">{entry.title}</span>}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* 日記詳細ポップアップ */}
                                    {selectedDateDetail && (
                                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setSelectedDateDetail(null)}>
                                            <div className="bg-white rounded-2xl p-5 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <span className="text-xs text-slate-400">{selectedDateDetail.date}</span>
                                                        <h3 className="text-lg font-bold text-slate-800">{selectedDateDetail.title}</h3>
                                                    </div>
                                                    <button onClick={() => setSelectedDateDetail(null)} className="text-slate-300 hover:text-slate-500"><i data-lucide="x-circle" className="w-6 h-6"></i></button>
                                                </div>
                                                <div className="bg-yellow-50 p-4 rounded-xl text-sm text-slate-700 leading-relaxed mb-4 max-h-[50vh] overflow-y-auto">
                                                    {selectedDateDetail.summary}
                                                </div>
                                                <div className="flex gap-2 flex-wrap">
                                                    {selectedDateDetail.tags?.map(t => <span key={t} className="px-2 py-1 bg-slate-100 rounded-md text-xs text-slate-500">#{t}</span>)}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="h-16 bg-[#f5f5f5] border-t border-slate-300 flex justify-around items-center flex-shrink-0 z-20 pb-safe">
                        <button onClick={() => setActiveTab("chat")} className={`flex flex-col items-center justify-center w-full h-full gap-1 ${activeTab === 'chat' ? 'text-slate-800' : 'text-slate-400'}`}>
                            <i data-lucide="message-circle" className={`w-6 h-6 ${activeTab === 'chat' && 'fill-current'}`}></i>
                            <span className="text-[10px] font-medium">トーク</span>
                        </button>
                        <button onClick={() => setActiveTab("calendar")} className={`flex flex-col items-center justify-center w-full h-full gap-1 ${activeTab === 'calendar' ? 'text-slate-800' : 'text-slate-400'}`}>
                            <i data-lucide="calendar" className={`w-6 h-6 ${activeTab === 'calendar' && 'fill-current'}`}></i>
                            <span className="text-[10px] font-medium">日記</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
