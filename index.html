<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE Diary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #7494c0; /* LINE風背景色 */ color: #1e293b; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        .bubble-tail-r::after { content: ""; position: absolute; top: 10px; right: -8px; border-style: solid; border-width: 8px 0 8px 10px; border-color: transparent transparent transparent #8de055; }
        .bubble-tail-l::after { content: ""; position: absolute; top: 10px; left: -8px; border-style: solid; border-width: 8px 10px 8px 0; border-color: transparent #ffffff transparent transparent; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_VERSION = "v1beta";

        // カレンダー用ユーティリティ
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const App = () => {
            // --- State ---
            const [hasKey, setHasKey] = useState(false);
            const [apiKey, setApiKey] = useState("");
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState("");
            
            const [activeTab, setActiveTab] = useState("chat"); // chat, calendar, settings
            const [messages, setMessages] = useState([]);
            const [diaries, setDiaries] = useState({}); // { "2026-01-30": { title:..., summary:... } }
            const [inputText, setInputText] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [selectedImage, setSelectedImage] = useState(null);
            const [selectedImageBase64, setSelectedImageBase64] = useState(null);
            
            // カレンダー用State
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDateDetail, setSelectedDateDetail] = useState(null);

            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- Init ---
            useEffect(() => {
                const savedKey = localStorage.getItem("gemini_api_key_new");
                const savedModel = localStorage.getItem("gemini_selected_model");
                const savedMsgs = localStorage.getItem("ai_diary_messages");
                const savedDiaries = localStorage.getItem("ai_diary_entries_map");

                if (savedKey) { setApiKey(savedKey); setHasKey(true); fetchModels(savedKey); }
                if (savedModel) setSelectedModel(savedModel);
                if (savedMsgs) setMessages(JSON.parse(savedMsgs));
                if (savedDiaries) setDiaries(JSON.parse(savedDiaries));
                else {
                    // デモデータ
                    setDiaries({
                        "2026-01-29": { title: "開発開始", summary: "日記アプリの開発を始めた。GeminiのAPIに苦戦中。", weather: "cloudy", tags:["dev"] }
                    });
                }
            }, []);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); if (activeTab === 'chat') scrollToBottom(); }, [messages, activeTab]);
            useEffect(() => { localStorage.setItem("ai_diary_messages", JSON.stringify(messages)); }, [messages]);
            useEffect(() => { localStorage.setItem("ai_diary_entries_map", JSON.stringify(diaries)); }, [diaries]);

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };

            // --- API Logic ---
            const fetchModels = async (key) => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/${API_VERSION}/models?key=${key}`);
                    const data = await res.json();
                    if (!res.ok) return;
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""))
                        .sort();
                    setAvailableModels(models);
                    if (!localStorage.getItem("gemini_selected_model") && models.length > 0) {
                        // ユーザー推奨の gemma-3-27b-it を優先検索
                        const best = models.find(m => m.includes("27b")) || models.find(m => m.includes("12b")) || models[0];
                        setSelectedModel(best);
                    }
                } catch (e) { console.error(e); }
            };

            const sendToGemini = async (prompt, imageBase64) => {
                const target = selectedModel || "gemma-3-12b-it"; 
                const url = `https://generativelanguage.googleapis.com/${API_VERSION}/models/${target}:generateContent?key=${apiKey}`;
                
                let parts = [{ text: prompt }];
                if (imageBase64) parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });
                
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || res.statusText);
                return data.candidates[0].content.parts[0].text;
            };

            const handleSend = async () => {
                if ((!inputText.trim() && !selectedImage) || isLoading) return;
                const now = new Date();
                const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const newUserMsg = { id: Date.now(), text: inputText, image: selectedImage, sender: "user", time: timeStr, timestamp: now.toISOString() };
                setMessages(prev => [...prev, newUserMsg]);
                setInputText("");
                setSelectedImage(null);
                setIsLoading(true);

                try {
                    const history = messages.slice(-10).map(m => `${m.sender}: ${m.text}`).join("\n");
                    const prompt = `あなたは親しい友人です。以下の会話の流れを読み、短く、共感的に返信してください。\n\n[履歴]\n${history}\nuser: ${inputText}`;
                    
                    const responseText = await sendToGemini(prompt, selectedImageBase64);
                    
                    const aiNow = new Date();
                    const aiTime = `${aiNow.getHours()}:${String(aiNow.getMinutes()).padStart(2, '0')}`;
                    setMessages(prev => [...prev, { id: Date.now() + 1, text: responseText, sender: "ai", time: aiTime, timestamp: aiNow.toISOString() }]);
                    setSelectedImageBase64(null);
                } catch (e) {
                    setMessages(prev => [...prev, { id: Date.now(), text: `⚠️ エラー: ${e.message}`, sender: "system", time: "--:--" }]);
                } finally { setIsLoading(false); }
            };

            // ★日記生成ロジック（厳格モード）
            const generateSummary = async () => {
                if (!confirm("これまでの会話から日記を作成し、カレンダーに保存しますか？")) return;
                setIsLoading(true);
                try {
                    // 今日の日付のメッセージだけ抽出
                    const todayStr = new Date().toDateString();
                    const targetMsgs = messages
                        .filter(m => new Date(m.timestamp).toDateString() === todayStr && m.sender !== 'system')
                        .map(m => `${m.sender}: ${m.text}`)
                        .join("\n");

                    if (!targetMsgs) throw new Error("今日の会話がまだありません。");

                    const prompt = `
あなたはプロの編集者です。以下の会話ログから「今日の日記」を作成してください。

【厳守ルール】
1. 出力は **JSONデータのみ**。マークダウン記号(\`\`\`json)や挨拶は一切禁止。
2. JSON形式: {"title": "短いタイトル", "summary": "300文字程度の日記本文。感情豊かに。", "weather": "sunny/cloudy/rainyのいずれか", "tags": ["タグ1", "タグ2"]}

【会話ログ】
${targetMsgs}
`;
                    const raw = await sendToGemini(prompt, null);
                    // JSONの掃除
                    const jsonStr = raw.replace(/```json|```/g, "").trim();
                    const data = JSON.parse(jsonStr);

                    // 保存処理 (YYYY-MM-DD形式をキーにする)
                    const todayKey = new Date().toISOString().split('T')[0]; // "2026-01-30"
                    
                    setDiaries(prev => ({ ...prev, [todayKey]: { ...data, timestamp: new Date().toISOString() } }));
                    alert(`日記「${data.title}」を保存しました！\nカレンダーを確認してください。`);
                    setActiveTab("calendar");

                } catch (e) {
                    alert("作成失敗: " + e.message + "\nモデルを変更して再試行してみてください。");
                } finally { setIsLoading(false); }
            };

            // --- Components ---
            const CalendarView = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = getDaysInMonth(year, month);
                const firstDay = getFirstDayOfMonth(year, month);
                const days = [];
                
                // 空白埋め
                for (let i = 0; i < firstDay; i++) days.push(null);
                // 日付埋め
                for (let i = 1; i <= daysInMonth; i++) days.push(i);

                return (
                    <div className="h-full flex flex-col bg-white">
                        <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))}><i data-lucide="chevron-left"></i></button>
                            <h2 className="font-bold text-lg">{year}年 {month + 1}月</h2>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))}><i data-lucide="chevron-right"></i></button>
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto">
                            <div className="grid grid-cols-7 gap-2 mb-4 text-center text-xs text-gray-500">
                                <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
                            </div>
                            <div className="grid grid-cols-7 gap-2">
                                {days.map((day, idx) => {
                                    if (!day) return <div key={idx}></div>;
                                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const hasDiary = diaries[dateKey];
                                    return (
                                        <div key={idx} 
                                            onClick={() => hasDiary && setSelectedDateDetail({ date: dateKey, ...hasDiary })}
                                            className={`aspect-square flex flex-col items-center justify-center rounded-lg relative cursor-pointer ${hasDiary ? 'bg-green-100 border-2 border-green-400' : 'bg-slate-50'}`}
                                        >
                                            <span className="text-sm font-medium">{day}</span>
                                            {hasDiary && <div className="w-2 h-2 bg-green-500 rounded-full mt-1"></div>}
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* 日記詳細モーダル風表示 */}
                            {selectedDateDetail && (
                                <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-xl shadow-sm">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-lg text-slate-800">{selectedDateDetail.date} の日記</h3>
                                        <button onClick={() => setSelectedDateDetail(null)} className="text-slate-400"><i data-lucide="x" className="w-5 h-5"></i></button>
                                    </div>
                                    <div className="font-bold text-green-700 mb-2">{selectedDateDetail.title}</div>
                                    <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{selectedDateDetail.summary}</p>
                                    <div className="mt-3 flex gap-2">
                                        {selectedDateDetail.tags?.map(t => <span key={t} className="text-xs bg-white px-2 py-1 rounded border text-slate-500">#{t}</span>)}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // --- Render ---
            if (!hasKey) return (
                <div className="h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white">
                    <h1 className="text-2xl font-bold mb-8">LINE Diary Setup</h1>
                    <input type="text" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="API Key" className="w-full p-4 rounded bg-slate-800 border border-slate-700 mb-4"/>
                    <button onClick={()=> {localStorage.setItem("gemini_api_key_new", apiKey); setHasKey(true); fetchModels(apiKey);}} className="w-full bg-green-500 py-3 rounded font-bold text-black">開始</button>
                </div>
            );

            return (
                <div className="h-screen flex flex-col bg-[#7494c0] overflow-hidden max-w-md mx-auto shadow-2xl">
                    {/* Header */}
                    <header className="h-14 bg-[#f5f5f5]/90 backdrop-blur border-b border-slate-200 flex justify-between items-center px-4 z-10">
                        <h1 className="font-bold text-slate-700">{activeTab === 'chat' ? (selectedModel || '読込中...') : 'カレンダー'}</h1>
                        <div className="flex gap-3">
                            {activeTab === 'chat' && <button onClick={generateSummary} className="bg-slate-200 p-2 rounded-full text-slate-600 active:bg-slate-300"><i data-lucide="book-open-check" className="w-5 h-5"></i></button>}
                            <select onChange={e => {setSelectedModel(e.target.value); localStorage.setItem("gemini_selected_model", e.target.value);}} value={selectedModel} className="w-4 h-4 opacity-0 absolute right-4">
                                {availableModels.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                            <i data-lucide="settings" className="w-5 h-5 text-slate-400 pointer-events-none"></i>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'chat' ? (
                            <div className="h-full flex flex-col">
                                {/* Messages Area */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {messages.map((msg) => (
                                        <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} items-end gap-2`}>
                                            {msg.sender === 'ai' && <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold border border-slate-200">AI</div>}
                                            
                                            <div className={`relative max-w-[70%] p-3 text-sm rounded-xl shadow-sm ${
                                                msg.sender === 'user' 
                                                ? 'bg-[#8de055] text-black bubble-tail-r mr-2' 
                                                : 'bg-white text-black bubble-tail-l ml-2'
                                            }`}>
                                                {msg.image && <img src={msg.image} className="rounded mb-2 max-w-full" />}
                                                {msg.text}
                                            </div>
                                            
                                            <span className="text-[10px] text-white mb-1">{msg.time}</span>
                                        </div>
                                    ))}
                                    {isLoading && <div className="text-center text-xs text-white/70 mt-2">既読...</div>}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input Area */}
                                <div className="bg-white px-3 py-2 flex items-center gap-2">
                                    <button onClick={()=>fileInputRef.current.click()} className="text-slate-500 p-1"><i data-lucide="plus" className="w-6 h-6"></i></button>
                                    <input type="file" ref={fileInputRef} onChange={e => {
                                        const file = e.target.files[0];
                                        if(file){
                                            setSelectedImage(URL.createObjectURL(file));
                                            const r = new FileReader();
                                            r.onload = () => setSelectedImageBase64(r.result.replace("data:", "").replace(/^.+,/, ""));
                                            r.readAsDataURL(file);
                                        }
                                    }} className="hidden" />
                                    
                                    <div className="flex-1 bg-slate-100 rounded-2xl flex items-center px-3 py-1">
                                        <textarea 
                                            value={inputText} 
                                            onChange={e => setInputText(e.target.value)} 
                                            placeholder="メッセージを入力"
                                            className="w-full bg-transparent border-none outline-none text-sm resize-none h-6 py-1"
                                            rows="1"
                                        />
                                    </div>
                                    <button onClick={handleSend} disabled={isLoading} className={`p-2 rounded-full ${inputText || selectedImage ? 'text-blue-500' : 'text-slate-300'}`}>
                                        <i data-lucide="send" className="w-6 h-6"></i>
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <CalendarView />
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="h-16 bg-[#f5f5f5] border-t border-slate-200 flex justify-around items-center">
                        <button onClick={() => setActiveTab("chat")} className={`flex flex-col items-center gap-1 ${activeTab === 'chat' ? 'text-slate-800' : 'text-slate-400'}`}>
                            <i data-lucide="message-circle" className="w-6 h-6"></i>
                            <span className="text-[10px]">トーク</span>
                        </button>
                        <button onClick={() => setActiveTab("calendar")} className={`flex flex-col items-center gap-1 ${activeTab === 'calendar' ? 'text-slate-800' : 'text-slate-400'}`}>
                            <i data-lucide="calendar" className="w-6 h-6"></i>
                            <span className="text-[10px]">カレンダー</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
